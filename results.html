<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JobList365 ‚Äì Search Results</title>
<meta name="description" content="Search results of verified job listings on JobList365" />
<meta name="google-site-verification" content="your-new-verification-code-here" />
<link rel="icon" href="logo.png">
<style>
  :root{--deep:#0d47a1;--mid:#1565c0;--light:#f5f9ff;--accent:#1976d2}
  body{font-family:Segoe UI,Roboto,Arial;background:var(--light);margin:0;color:#222;-webkit-font-smoothing:antialiased}
  header{background:linear-gradient(90deg,var(--mid),var(--accent));color:#fff;padding:14px 12px;display:flex;align-items:center;gap:12px}
  header .back{font-size:1.1rem;cursor:pointer;padding:8px;border-radius:8px;background:rgba(255,255,255,0.06)}
  header h1{margin:0;font-size:1.1rem}
  .wrap{max-width:900px;margin:18px auto;padding:12px}
  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .controls button{padding:8px 10px;border-radius:8px;border:1px solid #ccdff6;background:#fff;cursor:pointer;font-weight:700}
  .favActive{background:#ffeef2;border-color:#ff9fb2;color:#b71c1c}
  .notInt{background:#f4f6f8;color:#667; border:1px solid #e3eef9}
  .card{background:#fff;border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 18px rgba(16,52,122,0.04);display:flex;flex-direction:column;gap:8px}
  .comp{font-weight:800;color:var(--deep);font-size:1rem}
  .meta{color:#556; font-size:.95rem}
  .roles{color:#0d47a1;font-weight:700}
  .actions{display:flex;gap:8px;align-items:center;margin-top:6px}
  .btnBlue{background:var(--accent);color:#fff;padding:8px 10px;border-radius:8px;text-decoration:none;font-weight:700}
  .small{font-size:.9rem;color:#556}
  footer{background:var(--light);padding:14px;text-align:center;color:#334a64;margin-top:16px}
  .note{color:#d32f2f;font-weight:700;margin-top:12px}
</style>
</head>
<body>

<header>
  <div class="back" id="backBtn">‚Üê Back</div>
  <h1>JobList365 ‚Äì Search Results</h1>
</header>

<main class="wrap">
  <div id="favMsg" style="background:#fff3f6;border:1px solid #ffd6dd;padding:10px;border-radius:10px;margin-bottom:12px;font-weight:700;color:#b71c1c">‚≠ê Favorites always shown first</div>

  <div class="controls">
    <button id="showFav" class="favActive">‚ù§Ô∏è Favorites</button>
    <button id="toggleHide" class="notInt">üö´ Not Interested</button>
    <div style="margin-left:auto" id="resultsCount" class="small">Loading‚Ä¶</div>
  </div>

  <div id="resultsContainer"></div>

  <!-- Exit ad placeholder: we'll show a video/banner only once when user attempts to leave -->
  <div id="exitAd" style="display:none;margin-top:14px;border-radius:10px;overflow:hidden"></div>

  <p class="note">Note: If you don't find new openings here, please verify thoroughly from your end on the company's official career page or LinkedIn.</p>
</main>

<footer>
  <a href="index.html">Home</a> |
  <a href="about.html">About</a> |
  <a href="terms.html">Terms</a>
  <div style="margin-top:8px;font-size:.9rem;color:#556">¬© 2025 JobList365</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const CSV_URL = 'data.csv';
let csv = [];
let favourites = JSON.parse(localStorage.getItem('jl_favs'||'[]'))||[];
let hidden = JSON.parse(localStorage.getItem('jl_hidden'||'[]'))||[];

/* parse query params */
function getParams(){ const u = new URLSearchParams(location.search); return { q:u.get('q')||'', sector:u.get('sector')||'', state:u.get('state')||'' }; }

/* load CSV */
async function loadCsv(){
  try{
    const res = await fetch(CSV_URL + '?t=' + Date.now());
    const txt = await res.text();
    const parsed = Papa.parse(txt,{header:true,skipEmptyLines:true});
    csv = parsed.data || [];
    renderResults();
  }catch(e){ console.error(e); document.getElementById('resultsContainer').innerText='Unable to load data.' }
}

/* utils */
function matches(row, params){
  const q = params.q.trim().toLowerCase();
  if (params.sector && row.Sector !== params.sector) return false;
  if (params.state && row.State !== params.state) return false;
  if (!q) return true;
  // match company or roles
  const text = ((row.Company||'') + ' ' + (row.Roles||'')).toLowerCase();
  return text.includes(q);
}

/* render results (favorites first) */
function renderResults(){
  const params = getParams();
  const matched = csv.filter(r=>matches(r,params) && !hidden.includes((r.CIN||r.Company)));
  // annotate counts: roles could be a semicolon list or free text; we'll show counts only if numeric found
  matched.sort((a,b)=>{
    const aFav = favourites.includes((a.CIN||a.Company))?1:0;
    const bFav = favourites.includes((b.CIN||b.Company))?1:0;
    return bFav - aFav; // favorites first
  });
  const container = document.getElementById('resultsContainer');
  container.innerHTML = '';
  document.getElementById('resultsCount').textContent = matched.length + ' results';
  if (!matched.length) { container.innerHTML = '<div style="padding:14px;background:#fff;border-radius:10px">No results found.</div>'; return; }
  matched.forEach(row=>{
    const id = (row.CIN||row.Company);
    const card = document.createElement('div'); card.className='card';
    const comp = document.createElement('div'); comp.className='comp'; comp.textContent = row.Company || '(Unknown)';
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = row.Sector ? row.Sector : '';
    const rolesDiv = document.createElement('div'); rolesDiv.className='roles';
    // roles formatting: if Roles contains numbers, keep; otherwise show as "Software positions - X" only if count number found
    let rolesText = row.Roles || '';
    // try to detect a number count like "25" inside Roles
    const numMatch = (rolesText.match(/(\d{1,5})/));
    if (numMatch) {
      rolesDiv.textContent = rolesText;
    } else if (rolesText.trim()) {
      rolesDiv.textContent = rolesText;
    } else {
      rolesDiv.textContent = 'Not mentioned';
    }

    // actions
    const actions = document.createElement('div'); actions.className='actions';
    const siteBtn = document.createElement('a'); siteBtn.className='btnBlue'; siteBtn.target='_blank';
    siteBtn.rel='noopener noreferrer';
    siteBtn.textContent = 'Career Page';
    if (row.ApplyLink){ siteBtn.href = row.ApplyLink; } else if (row.Website) { siteBtn.href = row.Website; } else { siteBtn.href = '#'; siteBtn.style.opacity=.6; siteBtn.style.pointerEvents='none'; }
    const favBtn = document.createElement('button'); favBtn.textContent = favourites.includes(id)?'‚ù§Ô∏è Favorited':'ü§ç Favorite';
    favBtn.style.border='none'; favBtn.style.padding='8px 10px'; favBtn.style.borderRadius='8px'; favBtn.style.cursor='pointer';
    favBtn.addEventListener('click', ()=>{
      if (favourites.includes(id)) { favourites = favourites.filter(x=>x!==id); favBtn.textContent='ü§ç Favorite'; }
      else { favourites.push(id); favBtn.textContent='‚ù§Ô∏è Favorited'; }
      localStorage.setItem('jl_favs', JSON.stringify(favourites));
      renderResults();
    });
    const hideBtn = document.createElement('button'); hideBtn.textContent='üö´ Not Interested';
    hideBtn.style.border='none'; hideBtn.style.padding='8px 10px'; hideBtn.style.borderRadius='8px'; hideBtn.style.cursor='pointer';
    hideBtn.addEventListener('click', ()=>{
      if (!hidden.includes(id)) hidden.push(id);
      localStorage.setItem('jl_hidden', JSON.stringify(hidden));
      renderResults();
    });

    actions.appendChild(siteBtn); actions.appendChild(favBtn); actions.appendChild(hideBtn);

    card.appendChild(comp);
    if (meta.textContent) card.appendChild(meta);
    card.appendChild(rolesDiv);
    card.appendChild(actions);
    container.appendChild(card);
  });
}

/* back button */
document.getElementById('backBtn').addEventListener('click', ()=>{ history.back(); });

/* favorites toggle shows only favorites when active */
document.getElementById('showFav').addEventListener('click', ()=>{
  // toggle behavior: if active -> show all; if not active -> filter to favorites
  const btn = document.getElementById('showFav');
  if (btn.classList.contains('favActive')) {
    btn.classList.remove('favActive'); btn.textContent='‚ù§Ô∏è Favorites';
    // clear filter: reload original
    renderResults();
  } else {
    btn.classList.add('favActive'); btn.textContent='Showing favorites';
    // filter to favourites only
    const container = document.getElementById('resultsContainer');
    container.innerHTML = '';
    const favRows = csv.filter(r=>favourites.includes((r.CIN||r.Company)) && !hidden.includes((r.CIN||r.Company)));
    if (!favRows.length) { container.innerHTML='<div style="padding:14px;background:#fff;border-radius:10px">No favorites yet.</div>'; return; }
    favRows.forEach(row=>{
      const id=(row.CIN||row.Company);
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<div class="comp">${row.Company||''}</div><div class="meta">${row.Sector||''}</div><div class="roles">${row.Roles||'Not mentioned'}</div>
      <div class="actions"><a class="btnBlue" href="${row.ApplyLink||row.Website||'#'}" target="_blank">Career Page</a></div>`;
      container.appendChild(card);
    });
  }
});

/* hide toggler shows previously hidden list */
document.getElementById('toggleHide').addEventListener('click', ()=>{
  const container = document.getElementById('resultsContainer');
  container.innerHTML = '';
  const hiddenRows = csv.filter(r=>hidden.includes((r.CIN||r.Company)));
  if (!hiddenRows.length) { container.innerHTML='<div style="padding:14px;background:#fff;border-radius:10px">No hidden items.</div>'; return; }
  hiddenRows.forEach(row=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<div class="comp">${row.Company||''}</div><div class="meta">${row.Sector||''}</div><div class="roles">${row.Roles||'Not mentioned'}</div>`;
    container.appendChild(card);
  });
});

/* Exit intent ad: show only once per visitor */
let exitShown = localStorage.getItem('jl_exit_shown') === '1';
function showExitAd(){
  if (exitShown) return;
  exitShown = true; localStorage.setItem('jl_exit_shown','1');
  const box = document.getElementById('exitAd');
  // placeholder video or ad embed; lazy load iframe
  box.style.display='block';
  box.innerHTML = '<div style="background:#000;color:#fff;padding:12px;border-radius:8px">Showing ad ‚Äî <button id="closeExit" style="margin-left:8px;padding:6px;border-radius:6px;">Close</button></div><div style="margin-top:8px"><iframe width="100%" height="250" src="https://www.youtube.com/embed/dQw4w9WgXcQ?rel=0&autoplay=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div>';
  document.getElementById('closeExit').addEventListener('click', ()=>box.style.display='none');
}

/* hook exit intent (first attempt to leave) */
let leaveAttempted = false;
document.addEventListener('mouseleave', (e)=>{ if (e.clientY <= 0 && !leaveAttempted){ leaveAttempted = true; showExitAd(); } });
window.addEventListener('blur', ()=>{ if (!leaveAttempted){ leaveAttempted = true; showExitAd(); } });

/* init */
loadCsv();

</script>
</body>
</html>
